<html>
<body>
	<div class="resale-pred">
	<hr/>
		<h4>Price Estimation</h4>
		<div id = "resale-form">	
			<form>
				<input id="pred_pid" type="hidden" th:value="${allTxn[0].project.projectId}"/>	
				
				<div class="pred-form-input">
				
					<label for="pred-floor">Floor Range</label>
					<div class="form-group row">
					    <select id="pred-floor" class="form-select form-select-lg mb-3" th:field="*{floorFilter}">
					      	<option th:each = "range : ${floorFilter}" th:if="${range != 'All'}" th:value="${range}" th:text="${range}"></option>
					    </select>
					</div>
	    			
	    			<label for="pred-area">Floor Area</label>
	    			<div class="form-group row">	
					    <select id="pred-area" class="form-select form-select-lg mb-3" th:field="*{areaFilter}">
					      	<option th:each = "size : ${areaFilter}" th:if="${size != 'All'}" th:value="${size}" th:text="${size}"></option>
					    </select>
					</div>
					
					<label for="pred-district">District</label>
					<div class="form-group row">	
					    <select id="pred-district" class="form-select form-select-lg mb-3" th:field="*{districtFilter}">
					      	<option th:each = "dist : ${districtFilter}" th:value="${dist}" th:text="${dist}"></option>
					    </select>
					</div>
					
					<label for="pred-top">TOP Year</label>
					<div class="form-group row">	
					    <select id="pred-top" class="form-select form-select-lg mb-3" th:field="*{topFilter}">
					      	<option th:each = "top : ${topFilter}" th:value="${top}" th:text="${top}"></option>
					    </select>
					    <p>TOP is 0 for freehold properties</p>
					</div>
					
					<label for="pred-tenure">Tenure (Years)</label>
					<div class="form-group row">	
					    <select id="pred-tenure" class="form-select form-select-lg mb-3" th:field="*{tenureFilter}">
					      	<option th:each = "tenure : ${tenureFilter}" th:value="${tenure}" th:text="${tenure}"></option>
					    </select>
					</div>
					
				</div>
				<div id ="est-btn" class="form-group row">
				     <button type="button" class="btn btn-primary" onclick="predict()">Estimate Price</button >
				</div>
			</form>
		</div>
		
		<div id = "price-pred" style="display: none">
			<table class="table table-bordered border-primary">
				<tr>
					<th>Price / mÂ²</th>
					<th>Total Price </th>
				</tr>
				<tr>
					<td><span id="price"></span></td>
					<td><span id="tot-price"></span></td>
				</tr>
			</table>
		</div> 
	</div>
	<div class="container" style="height: 100px;">
	
	<script>
		function formatCurrency(price) {
			return '$ ' + price.toLocaleString('en-US', {style: 'currency', currency: "SGD"});
		}
		
		function determineFloor(floorRange) {
			if (floorRange == "-") {
				return 1
			} else {
				var floor = floorRange.split("-")[0]
				if (floor.charAt(0) == '0') {
					return floor.substring(1)
				} else if (isNan(Number(floor))) {
					return "0"
				} else {
					return floor
				}
			}
		}
		
		function determineDistrict(district) {
			if (district.charAt(0) == '0') {
				return district.substring(1)
			} else {
				return district
			}
		}
	
		function predict() {
			
			var currDate = new Date();
			
			var pid = document.getElementById("pred_pid").value
			var district = determineDistrict(document.getElementById("pred-district").value)
			var floorArea = Number(document.getElementById("pred-area").value)
			var floorRange = determineFloor(document.getElementById("pred-floor").value)
			var top = document.getElementById("pred-top").value
			var tenure = document.getElementById("pred-tenure").value
			var year = currDate.getFullYear().toString().substring(2)
			var month = (currDate.getMonth() + 1).toString()
			
			var info = {
				"projectId": pid, 
				"district": district,
				"floor_area": floorArea,
				"floor_range": floorRange,
				"top": top,
				"tenure": tenure,
				"year": year,
				"month": month};
		
			$.ajax({
				type: 'GET',
        		url: "http://127.0.0.1:5000",
        		// data: JSON.stringify(info),
        		headers: info,
        		contentType: "application/json",
        		dataType: 'json',
        		success: function(result){
            		price = result[0][0]
            		document.getElementById("price").innerHTML = formatCurrency(price / floorArea);
            		document.getElementById("tot-price").innerHTML = formatCurrency(price);
            		document.getElementById("price-pred").style.display="block";
        		}
    		})
		}	
	</script>
	
</body>
</html>